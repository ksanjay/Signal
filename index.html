<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-M">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stock/ETF Signal Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #final-signal-display {
            @apply px-8 py-5 text-2xl sm:text-3xl font-bold text-center text-white rounded-lg shadow-lg transition-all duration-300;
        }
        .indicator-row {
            @apply flex justify-between items-center p-4 bg-gray-50 rounded-lg border border-gray-200;
        }
        .indicator-name {
            @apply font-semibold text-gray-800;
        }
        .indicator-value {
            @apply text-sm text-gray-600;
        }
        .indicator-state {
            @apply px-3 py-1 text-sm font-semibold rounded-full;
        }
        .state-bullish {
            @apply bg-green-100 text-green-800;
        }
        .state-bearish {
            @apply bg-red-100 text-red-800;
        }
        .state-neutral {
            @apply bg-gray-100 text-gray-800;
        }
    </style>
    <!-- Chosen Palette: Warm Neutral (bg-gray-100, text-gray-800, white cards, with green-600, red-600, and blue-700 accents) -->
    <!-- Application Structure Plan: A single-card "Calculator" layout. The UI is split into three parts: 1) A display of the (mock) input data, 2) A "Calculate" button to trigger the logic, 3) An output area for the final signal and a detailed breakdown of each indicator's calculated value and state. This structure is chosen to clearly separate "input data" from "process" from "output signal," directly answering the user's request for an app that "takes in data" and "outputs a signal." -->
    <!-- Visualization & Content Choices:
        - Input Data: Goal(Inform) -> A disabled <textarea> showing a snippet of the JSON mock data. This clarifies what "data" the app is "taking in."
        - Output Signal: Goal(Inform) -> A large colored "pill" (HTML/CSS) to display the final result (Hedge/Long/Neutral).
        - Output Breakdown: Goal(Inform/Analyze) -> A dynamic HTML list. JS populates this list with the *exact calculated value* for each indicator (e.g., "RSI: 28.5") and its resulting state ("Bullish"). This provides transparency into *how* the final signal was derived from the calculations.
        - No charts are used, as the goal is not historical exploration (like the previous app) but to show the *result* of a calculation on the *latest* data point.
        - All choices adhere to the NO SVG/Mermaid constraint.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-16">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
                Live Strategy Signal Calculator
            </h1>
            <p class="mt-4 text-lg text-gray-600">
                This app calculates the final trading signal from raw data based on the "3-out-of-5" indicator strategy.
            </p>
        </header>

        <div class="bg-white shadow-2xl rounded-2xl overflow-hidden">
            <div class="grid md:grid-cols-2 gap-px bg-gray-200">
                
                <div class="bg-white p-6 sm:p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">1. Market Selection</h2>
                    <p class="text-sm text-gray-600 mb-4">
                       Enter a stock/ETF symbol (e.g., AAPL, SPY, MSFT) to fetch the latest ~100 daily data periods.
                    </p>
                    <div>
                        <div>
                            <label for="symbol-input" class="block text-sm font-medium text-gray-700">Stock/ETF Symbol</label>
                            <input type="text" id="symbol-input" value="AAPL" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <div id="data-status" class="mt-4 text-sm text-gray-500 font-mono h-40 p-3 border border-gray-200 rounded-lg bg-gray-50 overflow-y-auto">
                        Ready to fetch data.
                    </div>
                </div>
                
                <div class="bg-white p-6 sm:p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">2. Calculated Signal</h2>
                    <button id="calculate-button" class="w-full mb-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-400">
                        Calculate Latest Signal
                    </button>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Final Composite Signal:</h3>
                    <div id="final-signal-display" class="bg-gray-500">
                        ...
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mt-8 mb-3">Indicator Breakdown:</h3>
                    <div id="indicator-breakdown" class="space-y-3">
                        <div class="indicator-row">
                            <span class="indicator-name">RSI (18)</span>
                            <span id="rsi-value" class="indicator-value">...</span>
                            <span id="rsi-state" class="indicator-state state-neutral">...</span>
                        </div>
                        <div class="indicator-row">
                            <span class="indicator-name">MACD (12, 26, 9)</span>
                            <span id="macd-value" class="indicator-value">...</span>
                            <span id="macd-state" class="indicator-state state-neutral">...</span>
                        </div>
                        <div class="indicator-row">
                            <span class="indicator-name">Bollinger Bands (20, 2.5)</span>
                            <span id="bb-value" class="indicator-value">...</span>
                            <span id="bb-state" class="indicator-state state-neutral">...</span>
                        </div>
                        <div class="indicator-row">
                            <span class="indicator-name">Volume (vs 20 SMA)</span>
                            <span id="vol-value" class="indicator-value">...</span>
                            <span id="vol-state" class="indicator-state state-neutral">...</span>
                        </div>
                        <div class="indicator-row">
                            <span class="indicator-name">Price Trend (vs 50 SMA)</span>
                            <span id="trend-value" class="indicator-value">...</span>
                            <span id="trend-state" class="indicator-state state-neutral">...</span>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const dataStatusEl = document.getElementById('data-status');
            const calculateButton = document.getElementById('calculate-button');
            const symbolInput = document.getElementById('symbol-input');
            const apiKey = 'JQQUUJQRAX8TLXSM';

            const calculateSMA = (data, period) => {
                if (data.length < period) return 0;
                const slice = data.slice(-period);
                const sum = slice.reduce((acc, val) => acc + val, 0);
                return sum / period;
            };
            
            const calculateEMA = (data, period) => {
                if (data.length < period) return 0;
                const k = 2 / (period + 1);
                let ema = calculateSMA(data.slice(0, period), period);
                for (let i = period; i < data.length; i++) {
                    ema = (data[i] * k) + (ema * (1 - k));
                }
                return ema;
            };

            const calculateStDev = (data, period) => {
                if (data.length < period) return 0;
                const slice = data.slice(-period);
                const mean = calculateSMA(slice, period);
                const sqDiff = slice.map(val => Math.pow(val - mean, 2));
                const avgSqDiff = calculateSMA(sqDiff, period);
                return Math.sqrt(avgSqDiff);
            };

            const calculateRSI = (data, period) => {
                if (data.length <= period) return { rsi: 50, state: 'neutral' };
                let gains = 0;
                let losses = 0;

                for (let i = 1; i <= period; i++) {
                    const change = data[i] - data[i - 1];
                    if (change > 0) {
                        gains += change;
                    } else {
                        losses -= change;
                    }
                }
                
                let avgGain = gains / period;
                let avgLoss = losses / period;

                for (let i = period + 1; i < data.length; i++) {
                    const change = data[i] - data[i - 1];
                    let gain = change > 0 ? change : 0;
                    let loss = change < 0 ? -change : 0;
                    avgGain = (avgGain * (period - 1) + gain) / period;
                    avgLoss = (avgLoss * (period - 1) + loss) / period;
                }

                if (avgLoss === 0) return { rsi: 100, state: 'bearish' };
                
                const rs = avgGain / avgLoss;
                const rsi = 100 - (100 / (1 + rs));
                
                let state = 'neutral';
                if (rsi < 30) state = 'bullish';
                if (rsi > 70) state = 'bearish';
                
                return { value: rsi.toFixed(2), state: state };
            };
            
            const calculateMACD = (data, fastPeriod, slowPeriod, signalPeriod) => {
                const emaFast = calculateEMA(data, fastPeriod);
                const emaSlow = calculateEMA(data, slowPeriod);
                const macdLine = emaFast - emaSlow;
                
                const macdLines = [];
                let tempEmaFast = calculateSMA(data.slice(0, slowPeriod), fastPeriod);
                let tempEmaSlow = calculateSMA(data.slice(0, slowPeriod), slowPeriod);

                for (let i = slowPeriod; i < data.length; i++) {
                    const kFast = 2 / (fastPeriod + 1);
                    const kSlow = 2 / (slowPeriod + 1);
                    tempEmaFast = (data[i] * kFast) + (tempEmaFast * (1 - kFast));
                    tempEmaSlow = (data[i] * kSlow) + (tempEmaSlow * (1 - kSlow));
                    macdLines.push(tempEmaFast - tempEmaSlow);
                }

                if (macdLines.length < signalPeriod) return { value: 0, state: 'neutral' };

                const signalLine = calculateEMA(macdLines, signalPeriod);
                
                let state = macdLine > signalLine ? 'bullish' : 'bearish';
                let value = `Line: ${macdLine.toFixed(2)}, Sig: ${signalLine.toFixed(2)}`;

                return { value: value, state: state };
            };
            
            const calculateBBands = (data, period, multiplier) => {
                const lastClose = data[data.length - 1];
                const sma = calculateSMA(data, period);
                const stdDev = calculateStDev(data, period);
                const lowerBand = sma - (stdDev * multiplier);
                const upperBand = sma + (stdDev * multiplier);
                
                let state = 'neutral';
                let value = `Price: ${lastClose} (Band: ${lowerBand.toFixed(2)} - ${upperBand.toFixed(2)})`;
                
                if (lastClose < lowerBand) {
                    state = 'bearish';
                } else if (lastClose > lowerBand && lastClose < upperBand) {
                    state = 'bullish';
                }
                
                return { value: value, state: state };
            };
            
            const calculateVolumeSignal = (volumes, period) => {
                const lastVolume = volumes[volumes.length - 1];
                const smaVolume = calculateSMA(volumes, period);
                let state = lastVolume > smaVolume ? 'bullish' : 'bearish';
                let value = `Vol: ${lastVolume}, Avg: ${smaVolume.toFixed(0)}`;
                return { value: value, state: state };
            };
            
            const calculateTrendSignal = (closes, period) => {
                const lastClose = closes[closes.length - 1];
                const smaClose = calculateSMA(closes, period);
                let state = lastClose > smaClose ? 'bullish' : 'bearish';
                let value = `Price: ${lastClose}, Avg: ${smaClose.toFixed(2)}`;
                return { value: value, state: state };
            };

            const updateDom = (id, result) => {
                document.getElementById(`${id}-value`).textContent = result.value;
                const stateEl = document.getElementById(`${id}-state`);
                stateEl.textContent = result.state;
                stateEl.className = 'indicator-state';
                if (result.state === 'bullish') {
                    stateEl.classList.add('state-bullish');
                } else if (result.state === 'bearish') {
                    stateEl.classList.add('state-bearish');
                } else {
                    stateEl.classList.add('state-neutral');
                }
            };
            
            const fetchMarketData = async (symbol) => {
                dataStatusEl.textContent = `Fetching ${symbol} data...`;
                calculateButton.disabled = true;
                calculateButton.textContent = 'Loading Data...';

                try {
                    const response = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol.toUpperCase()}&apikey=${apiKey}&outputsize=compact`);
                    if (!response.ok) {
                        throw new Error(`Network error. (Status: ${response.status})`);
                    }
                    const data = await response.json();

                    if (data["Error Message"] || data["Note"]) {
                        throw new Error(data["Error Message"] || data["Note"]);
                    }
                    
                    const timeSeries = data["Time Series (Daily)"];
                    if (!timeSeries) {
                        throw new Error("Invalid API response. 'Time Series (Daily)' not found.");
                    }
                    
                    const dates = Object.keys(timeSeries).sort((a, b) => new Date(a) - new Date(b));
                    
                    if (dates.length < 60) {
                        throw new Error(`Not enough data found (${dates.length} periods). Need at least 60.`);
                    }

                    const closes = dates.map(date => parseFloat(timeSeries[date]["4. close"]));
                    const volumes = dates.map(date => parseFloat(timeSeries[date]["5. volume"]));
                    
                    dataStatusEl.textContent = `Successfully fetched ${dates.length} periods for ${symbol}.\n\nLast close: ${closes[closes.length - 1]}\nLast volume: ${volumes[volumes.length - 1]}`;
                    
                    return { closes, volumes };

                } catch (error) {
                    dataStatusEl.textContent = `Error: ${error.message}`;
                    return null;
                } finally {
                    calculateButton.disabled = false;
                    calculateButton.textContent = 'Calculate Latest Signal';
                }
            };
            
            calculateButton.addEventListener('click', async () => {
                const symbol = symbolInput.value;

                if (!symbol) {
                    dataStatusEl.textContent = 'Please enter a symbol.';
                    return;
                }

                const marketData = await fetchMarketData(symbol);
                
                if (!marketData) {
                    return;
                }

                const { closes, volumes } = marketData;
                
                const results = {
                    rsi: calculateRSI(closes, 18),
                    macd: calculateMACD(closes, 12, 26, 9),
                    bb: calculateBBands(closes, 20, 2.5),
                    vol: calculateVolumeSignal(volumes, 20),
                    trend: calculateTrendSignal(closes, 50)
                };
                
                updateDom('rsi', results.rsi);
                updateDom('macd', results.macd);
                updateDom('bb', results.bb);
                updateDom('vol', results.vol);
                updateDom('trend', results.trend);
                
                let bullishCount = 0;
                let bearishCount = 0;
                
                for (const result of Object.values(results)) {
                    if (result.state === 'bullish') {
                        bullishCount++;
                    } else if (result.state === 'bearish') {
                        bearishCount++;
                    }
                }
                
                const finalSignalEl = document.getElementById('final-signal-display');
                finalSignalEl.classList.remove('bg-green-600', 'bg-red-600', 'bg-gray-500');
                
                if (bullishCount >= 3) {
                    finalSignalEl.textContent = 'STRONG LONG SIGNAL';
                    finalSignalEl.classList.add('bg-green-600');
                } else if (bearishCount >= 3) {
                    finalSignalEl.textContent = 'STRONG HEDGE SIGNAL';
                    finalSignalEl.classList.add('bg-red-600');
                } else {
                    finalSignalEl.textContent = 'NEUTRAL / NO SIGNAL';
                    finalSignalEl.classList.add('bg-gray-500');
                }
            });
        });
    </script>
</body>
</html>
